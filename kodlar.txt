blogOlustur.handlebars:
{{! views/pages/blogOlustur.handlebars }}
<section class="blog-add-section">
  <div class="blog-add-form">
    <h1 class="blog-add-title">Kendi Tarihini Yaz!</h1>

    <form id="blogForm" method="POST" action="/blog/olustur">
      <input type="hidden" name="_csrf" value="{{csrfToken}}" />
      <div class="form-top">
        <input
          type="text"
          name="title"
          placeholder="Blog BaÅŸlÄ±ÄŸÄ±"
          class="input-field"
          required
        />

        <span class="img-hint">En uygun boyut: 1600Ã—900 â€¢ Max 10 MB</span>

        <div class="upload-wrapper">
          <label for="blogImages" class="upload-label">
            GÃ¶rsel YÃ¼kle (max 5)
          </label>
          <input
            type="file"
            id="blogImages"
            name="images"
            class="file-input"
            accept="image/*"
            multiple
          />
          <span id="fileCount" class="file-count">SeÃ§ili dosya yok</span>
        </div>
      </div>

      <div id="previewBox" class="preview-container"></div>

      <textarea
        name="content"
        class="textarea-field"
        rows="8"
        placeholder="Blog iÃ§eriÄŸini buraya yaz..."
        required
      ></textarea>

      <div class="warning-box">
        <strong>UyarÄ±:</strong>
        LÃ¼tfen hakaret iÃ§eren, yanlÄ±ÅŸ veya yanÄ±ltÄ±cÄ± tarih bilgileri, kiÅŸisel
        veriler ve telif hakkÄ± ihlali olabilecek iÃ§erikler paylaÅŸmayÄ±nÄ±z.
        GÃ¶nderilen bloglar, kulÃ¼p danÄ±ÅŸman Ã¶ÄŸretmeni tarafÄ±ndan kontrol
        edilebilir.
      </div>

      <input type="hidden" id="imageUrls" name="imageUrls" value="[]" />

      <button type="submit" class="submit-btn">Blogu OluÅŸtur</button>
    </form>
  </div>

  <div id="blogUploadLoading" class="blog-upload-loader" style="display:none;">
    <div class="blog-loader-box">
      <div class="blog-spinner"></div>
      <span>GÃ¶rseller yÃ¼kleniyor...</span>
    </div>
  </div>
</section>

<script src="/js/blogUpload.js"></script>

blogDuzenle.handlebars:
<section class="blog-edit">

  <h1 class="edit-title">Blog DÃ¼zenle</h1>

  <form id="blogEditForm" method="POST" action="/blog/duzenle/{{post._id}}">
    <input type="hidden" name="_csrf" value="{{csrfToken}}" />
    <input type="hidden" id="deleteImages" name="deleteImages" value="[]" />
    <input type="hidden" id="newImagesJson" name="newImagesJson" value="[]" />

    <!-- BaÅŸlÄ±k -->
    <div class="form-group">
      <label>BaÅŸlÄ±k</label>
      <input type="text" name="title" value="{{post.title}}" required />
    </div>

    <!-- Ä°Ã§erik -->
    <div class="form-group">
      <label>Ä°Ã§erik</label>
      <textarea name="content" rows="10" required>{{post.content}}</textarea>
    </div>

    <!-- Mevcut FotoÄŸraflar -->
    <div class="edit-gallery">
      <p class="gallery-title">Mevcut FotoÄŸraflar</p>

      {{#if post.images.length}}
        <div class="gallery-grid">
          {{#each post.images}}
            <div class="gallery-item">
              <img src="{{this.url}}" alt="GÃ¶rsel" />
              <label class="remove-label">
                <input
                  type="checkbox"
                  class="deleteImageCheck"
                  value="{{this.public_id}}"
                />
                Sil
              </label>
            </div>
          {{/each}}
        </div>
      {{else}}
        <p class="no-images">Bu blog iÃ§in henÃ¼z gÃ¶rsel eklenmemiÅŸ.</p>
      {{/if}}
    </div>

    <!-- Yeni FotoÄŸraf Ekle -->
    <div class="form-group">
      <label>Yeni FotoÄŸraf Ekle (Max 5)</label>
      <span class="img-hint">En uygun boyut: 1600Ã—900 â€¢ Max 10 MB</span>
      <input type="file" id="newImages" accept="image/*" multiple />
      <div id="editPreviewBox" class="preview-area"></div>
    </div>

    <button class="btn save">GÃ¼ncelle</button>
  </form>

  <div id="blogEditLoading" class="blog-upload-loader" style="display:none;">
    <div class="blog-loader-box">
      <div class="blog-spinner"></div>
      <span>GÃ¶rseller yÃ¼kleniyor...</span>
    </div>
  </div>

</section>

<script src="/js/blogEditUpload.js"></script>
<script src="/js/blogForm.js"></script>

/js/blogForm.js:
// =================================
// BLOG OLUÅTURMA FORMU
// =================================
const blogImagesInput = document.getElementById("blogImages");
const imageUrlsInput = document.getElementById("imageUrls");
let uploadedImages = [];

if (blogImagesInput) {
  blogImagesInput.addEventListener("change", async function (e) {
    const files = Array.from(e.target.files);
    uploadedImages = [];

    for (const file of files) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "tarihkulubu");

      const res = await fetch(
        "https://api.cloudinary.com/v1_1/deuntxojs/image/upload",
        { method: "POST", body: formData }
      );

      const data = await res.json();

      uploadedImages.push({
        url: data.secure_url,
        public_id: data.public_id,
      });
    }

    imageUrlsInput.value = JSON.stringify(uploadedImages);
  });
}

// =================================
// BLOG DÃœZENLEME FORMU
// =================================
const deleteImagesInput = document.getElementById("deleteImages");
const deleteChecks = document.querySelectorAll(".deleteImageCheck");

if (deleteChecks.length) {
  deleteChecks.forEach((checkbox) => {
    checkbox.addEventListener("change", () => {
      const selected = Array.from(deleteChecks)
        .filter((c) => c.checked)
        .map((c) => c.value);

      deleteImagesInput.value = JSON.stringify(selected);
    });
  });
}

// Yeni eklenen gÃ¶rseller
const newImagesInput = document.getElementById("newBlogImages");
const newImagesJson = document.getElementById("newImagesJson");

if (newImagesInput) {
  newImagesInput.addEventListener("change", async function (e) {
    const files = Array.from(e.target.files);
    let newImgs = [];

    for (const file of files) {
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", "tarihkulubu");

      const res = await fetch(
        "https://api.cloudinary.com/v1_1/deuntxojs/image/upload",
        { method: "POST", body: fd }
      );

      const data = await res.json();

      newImgs.push({
        url: data.secure_url,
        public_id: data.public_id,
      });
    }

    newImagesJson.value = JSON.stringify(newImgs);
  });
}

/js/blogEditUpload:
// public/js/blogEditUpload.js
document.addEventListener("DOMContentLoaded", () => {

  const cloudName = "deuntxojs";
  const uploadPreset = "tarihkulubu_unsigned";

  const newImagesInput = document.getElementById("newImages");
  const previewBox = document.getElementById("editPreviewBox");
  const newImagesJson = document.getElementById("newImagesJson");
  const deleteImagesInput = document.getElementById("deleteImages");
  const deleteCheckboxes = document.querySelectorAll(".deleteImageCheck");

  // === TAM EKRAN LOADER ===
  const loader = document.getElementById("blogEditLoading");

  function showLoader() {
    if (loader) loader.style.display = "flex";
  }

  function hideLoader() {
    if (loader) loader.style.display = "none";
  }

  // MEVCUT GÃ–RSELLER SÄ°LME
  deleteCheckboxes.forEach((chk) => {
    chk.addEventListener("change", () => {
      const checked = Array.from(deleteCheckboxes)
        .filter((c) => c.checked)
        .map((c) => c.value);

      deleteImagesInput.value = JSON.stringify(checked);
    });
  });

  // YENÄ° GÃ–RSELLER (UPLOAD)
  if (!newImagesInput || !previewBox || !newImagesJson) return;

  newImagesInput.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    if (files.length > 5) {
      alert("En fazla 5 yeni gÃ¶rsel ekleyebilirsiniz!");
      return;
    }

    // === LOADER AÃ‡ ===
    showLoader();

    previewBox.innerHTML = "<p style='padding:20px; text-align:center;'>YÃ¼kleniyor...</p>";

    const uploadPromises = files.map(async (file) => {
      try {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);

        const res = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
          { method: "POST", body: formData }
        );

        const result = await res.json();

        if (result.secure_url && result.public_id) {
          return {
            url: result.secure_url,
            public_id: result.public_id,
          };
        } else {
          throw new Error("Cloudinary hatalÄ± yanÄ±t verdi");
        }
      } catch (err) {
        console.error("Upload error:", err);
        throw err;
      }
    });

    try {
      const results = await Promise.allSettled(uploadPromises);

      const successful = results
        .filter((r) => r.status === "fulfilled")
        .map((r) => r.value);

      if (!successful.length) {
        previewBox.innerHTML =
          "<p style='color:red; padding:20px; text-align:center;'>YÃ¼kleme baÅŸarÄ±sÄ±z.</p>";
        newImagesJson.value = "[]";
        hideLoader();
        return;
      }

      newImagesJson.value = JSON.stringify(successful);

      const html = successful
        .map(
          (item) => `
          <div class="preview-item">
            <img src="${item.url}" alt="Preview" class="preview-img">
          </div>
        `
        )
        .join("");

      previewBox.innerHTML = html;

    } catch (err) {
      console.error(err);
      previewBox.innerHTML =
        "<p style='color:red; padding:20px; text-align:center;'>YÃ¼kleme sÄ±rasÄ±nda bir hata oluÅŸtu.</p>";
      newImagesJson.value = "[]";
    }

    // === LOADER KAPAT ===
    hideLoader();
  });
});

/js/blogUpload.js:
// public/js/blogUpload.js
document.addEventListener("DOMContentLoaded", () => {
  const cloudName = "deuntxojs";
  const uploadPreset = "tarihkulubu_unsigned";

  const fileInput = document.getElementById("blogImages");
  const previewBox = document.getElementById("previewBox");
  const imageUrlsInput = document.getElementById("imageUrls");
  const fileCount = document.getElementById("fileCount");

  // ğŸ”¥ TAM EKRAN LOADER
  const loader = document.getElementById("blogUploadLoading");

  function showLoader() {
    if (loader) loader.style.display = "flex";
  }

  function hideLoader() {
    if (loader) loader.style.display = "none";
  }

  if (!fileInput || !previewBox || !imageUrlsInput) return;

  let uploadedUrls = [];

  fileInput.addEventListener("change", async () => {
    const files = fileInput.files;

    if (!files || files.length === 0) {
      uploadedUrls = [];
      previewBox.innerHTML = "";
      imageUrlsInput.value = "[]";
      if (fileCount) fileCount.textContent = "SeÃ§ili dosya yok";
      return;
    }

    if (files.length > 5) {
      alert("En fazla 5 gÃ¶rsel yÃ¼kleyebilirsiniz!");
      fileInput.value = "";
      return;
    }

    // === LOADING BAÅLA ===
    showLoader();

    uploadedUrls = [];
    previewBox.innerHTML =
      "<p style='text-align:center; padding:20px;'>YÃ¼kleniyor...</p>";
    if (fileCount) fileCount.textContent = `YÃ¼kleniyor: ${files.length} dosya`;

    const uploadPromises = Array.from(files).map(async (file) => {
      try {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);

        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
          {
            method: "POST",
            body: formData,
          }
        );

        const result = await response.json();

        if (result.secure_url && result.public_id) {
          return {
            url: result.secure_url,
            public_id: result.public_id,
          };
        } else {
          console.error("Cloudinary upload hatasÄ±:", result);
          throw new Error(`GÃ¶rsel yÃ¼klenemedi: ${file.name}`);
        }
      } catch (err) {
        console.error("Upload error:", err);
        throw err;
      }
    });

    try {
      const results = await Promise.allSettled(uploadPromises);

      const successful = results
        .filter((r) => r.status === "fulfilled")
        .map((r) => r.value);

      const failed = results.filter((r) => r.status === "rejected").length;

      if (failed > 0) {
        alert(`${failed} gÃ¶rsel yÃ¼klenemedi. LÃ¼tfen tekrar deneyin.`);
      }

      if (successful.length === 0) {
        previewBox.innerHTML =
          "<p style='color:red; text-align:center; padding:20px;'>HiÃ§bir gÃ¶rsel yÃ¼klenemedi.</p>";
        imageUrlsInput.value = "[]";
        if (fileCount) fileCount.textContent = "SeÃ§ili dosya yok";
        hideLoader();
        return;
      }

      uploadedUrls = successful;

      const previews = successful
        .map(
          (item) => `
            <div class="preview-item">
              <img src="${item.url}" class="preview-img" alt="Preview" />
            </div>
          `
        )
        .join("");

      previewBox.innerHTML = previews;
      imageUrlsInput.value = JSON.stringify(uploadedUrls);

      if (fileCount) {
        fileCount.textContent = `${successful.length} dosya yÃ¼klendi`;
      }
    } catch (err) {
      console.error("Upload process error:", err);
      previewBox.innerHTML =
        "<p style='color:red; text-align:center; padding:20px;'>YÃ¼kleme sÄ±rasÄ±nda hata oluÅŸtu.</p>";
      imageUrlsInput.value = "[]";
    }

    // === LOADING BÄ°TÄ°R ===
    hideLoader();
  });
});

HESAP KISMI:
hesap.handlebars:
<link rel="stylesheet" href="/css/hesap.css" />

<section class="account-wrapper">

  <!-- SOL MENÃœ -->
  <aside class="account-sidebar">

    <a href="/u/@{{user.username}}" class="public-profile-btn">
      Profilimi GÃ¶rÃ¼ntÃ¼le â†’
    </a>

    <div class="sidebar-category">Hesap</div>
    <button class="sidebar-item active" data-target="profile">Profil Bilgileri</button>

    <div class="sidebar-category">Hesap AyarlarÄ±</div>
    <button class="sidebar-item disabled">Tema AyarlarÄ± (YakÄ±nda)</button>
    <button class="sidebar-item disabled">Bildirimler (YakÄ±nda)</button>

    <div class="sidebar-category">Profil MedyasÄ±</div>
    <button class="sidebar-item" data-target="media">Profil FotoÄŸraflarÄ±</button>

    <div class="sidebar-category">Sosyal</div>
    <button class="sidebar-item" data-target="social">Sosyal Medya</button>

    <div class="sidebar-category">Gizlilik & GÃ¼venlik</div>
    <button class="sidebar-item" data-target="password">Åifre DeÄŸiÅŸtir</button>
    <button class="sidebar-item" data-target="cookies">Ã‡erez AyarlarÄ±</button>
    <button class="sidebar-item" data-target="data-usage">Veri KullanÄ±mÄ±</button>
    <button class="sidebar-item" data-target="devices" disabled>GiriÅŸ YapÄ±lan Cihazlar (YakÄ±nda)</button>
    <button class="sidebar-item danger" data-target="delete">HesabÄ± Sil</button>
    <button class="sidebar-item" data-target="policies">Site PolitikalarÄ±</button>

    <div class="sidebar-category">GeliÅŸmiÅŸ GÃ¼venlik</div>
    <button class="sidebar-item disabled">2FA DoÄŸrulama (YakÄ±nda)</button>
    <button class="sidebar-item disabled">Oturum YÃ¶netimi (YakÄ±nda)</button>

  </aside>

  <!-- SAÄ PANEL -->
  <main class="account-content">

    <!-- âœ¨ LOADER -->
    <div id="accountLoading" class="account-loading">
      <div class="spinner"></div>
      <p>Hesap bilgileri yÃ¼kleniyor...</p>
    </div>

    <!-- PROFÄ°L -->
    <div class="content-box" id="profile" style="display: block;">
      <h2 class="title">Profil Bilgileri</h2>
      <p class="desc">Bilgileriniz gÃ¼vende. DilediÄŸiniz zaman gÃ¼ncelleyebilirsiniz.</p>

      <form action="/hesap/profil" method="POST">
        <input type="hidden" name="_csrf" value="{{csrfToken}}" />
        
        <div class="form-group">
          <label>KullanÄ±cÄ± AdÄ±</label>
          <input type="text" value="{{user.username}}" disabled />
          <span class="info">KullanÄ±cÄ± adÄ± deÄŸiÅŸtirilemez.</span>
        </div>

        <div class="form-group">
          <label>Ad</label>
          <input type="text" name="name" value="{{user.name}}" />
        </div>

        <div class="form-group">
          <label>Soyad</label>
          <input type="text" name="surname" value="{{user.surname}}" />
        </div>

        <div class="form-group">
          <label>E-posta</label>
          <input type="email" name="email" value="{{user.email}}" />
          <span class="info">E-posta doÄŸrulama ileride eklenecek.</span>
        </div>

        <!-- BÄ°YOGRAFÄ° -->
        <div class="form-group">
          <label>Biyografi</label>
          <textarea 
            name="bio" 
            rows="4" 
            maxlength="200"
            placeholder="Kendinizi tanÄ±tan kÄ±sa bir yazÄ±..."
          >{{user.bio}}</textarea>

          <div class="bio-hint">
            <span>200 karakter sÄ±nÄ±rÄ±</span>
          </div>
        </div>

        <div class="btn-group">
          <button type="submit" class="btn save">Kaydet</button>
          <button type="reset" class="btn cancel">Ä°ptal</button>
        </div>
      </form>
    </div>

    <!-- SOSYAL -->
    <div class="content-box" id="social">
      <h2 class="title">Sosyal Medya BaÄŸlantÄ±larÄ±</h2>
      <p class="desc">Profilinde gÃ¶rÃ¼necek sosyal medya baÄŸlantÄ±larÄ±.</p>

      <form action="/hesap/social" method="POST">
        <input type="hidden" name="_csrf" value="{{csrfToken}}" />

        <div class="form-group">
          <label>Instagram</label>
          <input type="text" name="instagram" value="{{user.social.instagram}}" placeholder="@kullanici" />
        </div>

        <div class="form-group">
          <label>X (Twitter)</label>
          <input type="text" name="x" value="{{user.social.x}}" placeholder="@kullanici" />
        </div>

        <div class="form-group">
          <label>GitHub</label>
          <input type="text" name="github" value="{{user.social.github}}" placeholder="github.com/kullanici" />
        </div>

        <div class="btn-group">
          <button type="submit" class="btn save">Kaydet</button>
          <button type="reset" class="btn cancel">Ä°ptal</button>
        </div>

      </form>
    </div>

    <!-- PROFÄ°L MEDYASI -->
    <div class="content-box" id="media">
      <h2 class="title">Profil FotoÄŸraflarÄ±</h2>
      <p class="desc">Profil ve kapak fotoÄŸrafÄ±nÄ±zÄ± buradan yÃ¶netebilirsiniz.</p>

      <!-- AVATAR -->
      <div class="profile-section">
        <h3>Profil FotoÄŸrafÄ±</h3>

        <div class="avatar-box">
          <img
            src="{{user.avatar}}"
            alt="Avatar"
            class="avatar-img"
            id="avatarPreview"
          />
        </div>

        <form id="avatarForm" action="/hesap/avatar-yukle" method="POST">
          <input type="hidden" name="_csrf" value="{{csrfToken}}" />

          <!-- GÃ¼ncel Cloudinary sistemine uygun inputlar -->
          <input type="hidden" id="avatarValue" name="avatarUrl">
          <input type="hidden" id="avatarPid" name="avatarPublicId">

          <label for="avatarUpload" class="upload-btn">Yeni Avatar YÃ¼kle</label>
          <input type="file" id="avatarUpload" class="hidden-input" accept="image/*" />

          <button type="submit" class="save-btn">Kaydet</button>
        </form>
      </div>

      <!-- KAPAK -->
      <div class="cover-section">
        <h3>Kapak FotoÄŸrafÄ±</h3>

        <div class="cover-box">
          <img
            src="{{user.coverPhoto}}"
            alt="Kapak"
            class="cover-img"
            id="coverPreview"
          />
        </div>

        <div id="mediaLoading" class="media-loading" style="display: none;">
          <div class="spinner"></div>
          <span>YÃ¼kleniyor...</span>
        </div>

        <form id="coverForm" action="/hesap/kapak-yukle" method="POST">
          <input type="hidden" name="_csrf" value="{{csrfToken}}" />

          <!-- Cloudinary iÃ§in gerekli inputlar -->
          <input type="hidden" id="coverValue" name="coverUrl">
          <input type="hidden" id="coverPid" name="coverPublicId">

          <label for="coverUpload" class="upload-btn">Yeni Kapak YÃ¼kle</label>
          <input type="file" id="coverUpload" class="hidden-input" accept="image/*" />

          <button type="submit" class="save-btn">Kaydet</button>
        </form>
      </div>
    </div>

    <!-- ÅÄ°FRE -->
    <div class="content-box" id="password">
      <h2 class="title">Åifre DeÄŸiÅŸtir</h2>
      <p class="desc">Mail adresine doÄŸrulama kodu gÃ¶nderilecek.</p>

      <!-- 1) Kod gÃ¶nder -->
      <form action="/hesap/sifre-kod" method="POST">
        <input type="hidden" name="_csrf" value="{{csrfToken}}" />
        <button class="btn save">
          <i class="fa-solid fa-paper-plane"></i> Mailime Kod GÃ¶nder
        </button>
      </form>

      <!-- 2) DoÄŸrulama kutusu -->
      <div id="verifyBox" style="display: none; margin-top:20px;">
        <h3 class="subtitle">DoÄŸrulama Kodu</h3>

        <form action="/hesap/sifre-kod-dogrula-form" method="POST">
          <input type="hidden" name="_csrf" value="{{csrfToken}}" />
          <input type="text" name="code" placeholder="6 haneli kod" class="input" required />
          <button class="btn green">
            <i class="fa-solid fa-lock"></i> Kodu DoÄŸrula
          </button>
        </form>
      </div>

      <!-- 3) Yeni ÅŸifre -->
      <div id="newPasswordBox" style="display: {{#if showNewPasswordBox}}block{{else}}none{{/if}}; margin-top: 30px;">
        <h3 class="subtitle">Yeni Åifre OluÅŸtur</h3>

        <form action="/hesap/sifre-yeni" method="POST">
          <input type="hidden" name="_csrf" value="{{csrfToken}}" />
          <input type="password" name="password1" placeholder="Yeni Åifre" class="input" required />
          <input type="password" name="password2" placeholder="Yeni Åifre Tekrar" class="input" required />

          <button class="btn save">
            <i class="fa-solid fa-unlock-keyhole"></i> Åifreyi GÃ¼ncelle
          </button>
        </form>
      </div>

    </div>

    <!-- Ã‡EREZLER -->
    <div class="content-box" id="cookies">
      <h2 class="title">Ã‡erez AyarlarÄ±</h2>
      <p class="desc">TarayÄ±cÄ± Ã§erezleri deneyimi iyileÅŸtirir.</p>

      <form action="/hesap/cookies" method="POST">
        <input type="hidden" name="_csrf" value="{{csrfToken}}" />
        <div class="toggle-row">
          <label>Gerekli Ã‡erezler</label>
          <input type="checkbox" checked disabled />
        </div>

        <div class="toggle-row">
          <label>Analitik Ã‡erezler</label>
          <label class="switch">
            <input type="checkbox" name="analyticsCookies"
              {{#if user.analyticsCookies}}checked{{/if}} />
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-row">
          <label>KiÅŸiselleÅŸtirme Ã‡erezleri</label>
          <label class="switch">
            <input type="checkbox" name="personalizationCookies"
              {{#if user.personalizationCookies}}checked{{/if}} />
            <span class="slider"></span>
          </label>
        </div>

        <div class="btn-group">
          <button class="btn save">Kaydet</button>
          <button class="btn cancel" type="reset">Ä°ptal</button>
        </div>
      </form>
    </div>

    <!-- VERÄ° -->
    <div class="content-box" id="data-usage">
      <h2 class="title">Veri KullanÄ±mÄ±</h2>

      <form action="/hesap/data-usage" method="POST">
        <input type="hidden" name="_csrf" value="{{csrfToken}}" />
        <div class="toggle-row">
          <label>Hizmet kalitesi iÃ§in anonim veri</label>
          <label class="switch">
            <input type="checkbox" name="serviceDataUsage"
              {{#if user.serviceDataUsage}}checked{{/if}} />
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-row">
          <label>KiÅŸiselleÅŸtirilmiÅŸ iÃ§erik</label>
          <label class="switch">
            <input type="checkbox" name="personalizedContent"
              {{#if user.personalizedContent}}checked{{/if}} />
            <span class="slider"></span>
          </label>
        </div>

        <div class="btn-group">
          <button class="btn save">Kaydet</button>
          <button class="btn cancel" type="reset">Ä°ptal</button>
        </div>
      </form>
    </div>

    <!-- ========== HESAP SÄ°LME (SIDEBAR Ä°Ã‡ERÄ°ÄÄ°) ========== -->
    <div class="content-box" id="delete">
      <h2 class="title danger">HesabÄ± Sil</h2>
      <p class="desc">
        HesabÄ±nÄ±zÄ± kalÄ±cÄ± olarak silmek istiyorsanÄ±z aÅŸaÄŸÄ±daki butona tÄ±klayÄ±n.
        Bu iÅŸlem geri alÄ±namaz.
      </p>

      <button class="danger-btn" type="button" onclick="openDeleteModal()">
        HesabÄ±mÄ± KalÄ±cÄ± Olarak Sil
      </button>
    </div>

    <!-- POLÄ°TÄ°KALAR -->
    <div class="content-box" id="policies">
      <h2 class="title">Site PolitikalarÄ±</h2>
      <p class="desc">Gizlilik, veri politikasÄ± ve kullanÄ±m ÅŸartlarÄ±.</p>

      <div class="policy-card">
        <h3 class="policy-title">ğŸ“˜ AÃ§Ä±k RÄ±za Metni</h3>
        <a href="/legal/acik-riza-metni" class="policy-link">AÃ§Ä±k RÄ±za Metni â†’</a>
      </div>

      <div class="policy-card">
        <h3 class="policy-title">ğŸ”’ Gizlilik PolitikasÄ±</h3>
        <a href="/legal/gizlilik-politikasi" class="policy-link">Gizlilik PolitikasÄ± â†’</a>
      </div>

      <div class="policy-card">
        <h3 class="policy-title">ğŸ“„ KullanÄ±m ÅartlarÄ±</h3>
        <a href="/legal/kullanim-sartlari" class="policy-link">KullanÄ±m ÅartlarÄ± â†’</a>
      </div>

    </div>

    <!-- ========== HESAP SÄ°LME MODALI (OVERLAY) ========== -->
    <div id="deleteModal" class="delete-modal">
      <div class="delete-modal-content">

        <h2>HesabÄ± Sil</h2>
        <p class="warning-text">
          Bu iÅŸlem geri alÄ±namaz! HesabÄ±nÄ±zÄ± <b>kalÄ±cÄ± olarak</b> silmek istediÄŸinize emin misiniz?
        </p>

        <!-- Form: CSRF + ÅŸifre -->
        <form id="deleteForm" action="/hesap/sil" method="POST">
          <input type="hidden" name="_csrf" value="{{csrfToken}}" />

          <!-- C doÄŸrulamasÄ± -->
          <label class="modal-label">Onay iÃ§in <b>C</b> harfini girin:</label>
          <input
            type="text"
            id="confirmC"
            maxlength="1"
            class="modal-input"
            placeholder="C"
          />

          <!-- Åifre -->
          <label class="modal-label">Åifrenizi girin:</label>
          <input
            type="password"
            id="deletePassword"
            name="password"
            class="modal-input"
            placeholder="Åifreniz"
          />

          <p id="modalError" class="modal-error"></p>

          <!-- Butonlar -->
          <div class="modal-buttons">
            <button type="button" class="cancel-btn" onclick="closeDeleteModal()">VazgeÃ§</button>
            <button type="button" class="delete-btn" onclick="confirmDelete()">HesabÄ± Sil</button>
          </div>
        </form>

      </div>
    </div>

        <!-- GLOBAL LOADING OVERLAY -->
    <div id="globalLoader" class="global-loader" style="display:none;">
      <div class="loader-box">
        <div class="loader-spinner"></div>
        <span>YÃ¼kleniyor...</span>
      </div>
    </div>

  </main>
</section>

<script src="/js/avatarCoverUpload.js"></script>
<script src="/js/hesap.js"></script>

/js/avatarCoverUpload.js:
// public/js/avatarCoverUpload.js
document.addEventListener("DOMContentLoaded", () => {

  const cloudName = "deuntxojs";
  const uploadPreset = "unsigned_upload";

  // Global overlay loader
  const loader = document.getElementById("mediaLoading");

  function showLoader() {
    if (loader) loader.style.display = "flex";
  }

  function hideLoader() {
    if (loader) loader.style.display = "none";
  }

  // ===============================
  // CLOUDINARY UPLOAD
  // ===============================
  async function uploadToCloudinary(file) {
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", uploadPreset);

    try {
      const res = await fetch(
        `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
        { method: "POST", body: fd }
      );
      return await res.json();
    } catch (err) {
      console.error("Cloudinary Upload Error:", err);
      return null;
    }
  }

  function safeSetValue(id, value) {
    const el = document.getElementById(id);
    if (!el) return;

    el.value = value;
    setTimeout(() => (el.value = value), 50);
  }

  // ===============================
  // AVATAR UPLOAD
  // ===============================
  const avatarInput = document.getElementById("avatarUpload");
  const avatarPreview = document.getElementById("avatarPreview");

  if (avatarInput && avatarPreview) {
    avatarInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      showLoader();

      const reader = new FileReader();
      reader.onload = ev => (avatarPreview.src = ev.target.result);
      reader.readAsDataURL(file);

      const result = await uploadToCloudinary(file);

      hideLoader();

      if (!result) {
        alert("âš  Avatar yuklenemedi! (network)");
        return;
      }

      const finalUrl = result.secure_url || result.url;

      if (finalUrl && result.public_id) {
        safeSetValue("avatarValue", finalUrl);
        safeSetValue("avatarPid", result.public_id);
      } else {
        alert("âš  Avatar yuklenemedi!");
      }
    });
  }

  // ===============================
  // COVER UPLOAD
  // ===============================
  const coverInput = document.getElementById("coverUpload");
  const coverPreview = document.getElementById("coverPreview");

  if (coverInput && coverPreview) {
    coverInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      showLoader();

      const reader = new FileReader();
      reader.onload = ev => (coverPreview.src = ev.target.result);
      reader.readAsDataURL(file);

      const result = await uploadToCloudinary(file);

      hideLoader();

      if (!result) {
        alert("âš  Kapak yuklenemedi! (network)");
        return;
      }

      const finalUrl = result.secure_url || result.url;

      if (finalUrl && result.public_id) {
        safeSetValue("coverValue", finalUrl);
        safeSetValue("coverPid", result.public_id);
      } else {
        alert("âš  Kapak yuklenemedi!");
      }
    });
  }

});

routes/blogs.js:
import express from "express";
import Post from "../models/Post.js";
import Comment from "../models/Comment.js";
import auth from "../middlewares/auth.js";
import cloudinary from "../helpers/cloudinary.js";
import {
  blogValidation,
  commentValidation,
} from "../middlewares/validators.js";
import {
  blogCreateLimiter,
  commentLimiter,
} from "../middlewares/rateLimiter.js";
import logger from "../helpers/logger.js";
import upload from "../middlewares/upload.js";

const blogs = express.Router();

/* ============================================================
   BLOG OLUÅTUR (GET)
============================================================ */
blogs.get("/olustur", auth, (req, res) => {
  res.render("pages/blogOlustur", {
    error: req.query.error || null,
    success: req.query.success || null,
    data: {},
  });
});

/* ============================================================
   BLOG OLUÅTUR (POST)
============================================================ */
blogs.post(
  "/olustur",
  auth,
  (req, res, next) => {
    // VALIDATION ERROR'DA BURAYA DÃ–NECEK
    req.validationErrorView = "pages/blogOlustur";
    req.validationErrorData = { data: req.body };
    next();
  },
  blogCreateLimiter,
  blogValidation,
  async (req, res) => {
    try {
      const { title, content } = req.body;

      let images = [];
      if (req.body.imageUrls) {
        try {
          const parsed = JSON.parse(req.body.imageUrls);
          if (Array.isArray(parsed))
            images = parsed.filter(
              (img) => img?.url && img?.public_id
            );
        } catch (e) {
          logger.warn("JSON parse error:", e);
        }
      }

      await Post.create({
        user_id: req.user.id,
        username: req.user.username,
        title,
        content,
        images,
      });

      return res.redirect("/blog?success=Blog+baÅŸarÄ±yla+oluÅŸturuldu");
    } catch (err) {
      logger.error("Blog oluÅŸturma hatasÄ±:", {
        message: err.message,
        stack: err.stack,
        user: req.user?.username,
        ip: req.ip,
      });

      return res.redirect("/blog/olustur?error=Bir+hata+oluÅŸtu");
    }
  }
);

/* ============================================================
   BLOG DÃœZENLE (GET)
============================================================ */
blogs.get("/duzenle/:id", auth, async (req, res) => {
  try {
    const post = await Post.findById(req.params.id).lean();

    if (!post) {
      return res.redirect("/blog?error=Blog+bulunamadÄ±");
    }

    if (post.user_id.toString() !== req.user.id) {
      return res.redirect("/blog?error=Bu+blogu+dÃ¼zenleme+yetkin+yok");
    }

    res.render("pages/blogDuzenle", {
      post,
      csrfToken: req.csrfToken(),
    });
  } catch (err) {
    console.log(err);
    return res.redirect("/blog?error=Bir+hata+oluÅŸtu");
  }
});

/* ============================================================
   BLOG DÃœZENLE (POST)
============================================================ */
blogs.post("/duzenle/:id", auth, async (req, res) => {
  try {
    const blog = await Post.findById(req.params.id);
    if (!blog) return res.status(404).render("pages/404");

    // Sahip mi / admin mi?
    const isOwner = blog.user_id.toString() === req.user.id;
    const isAdmin = req.user.role === "admin";
    if (!isOwner && !isAdmin) {
      return res.status(403).send("Yetkisiz iÅŸlem");
    }

    const { title, content } = req.body;

    // 1) Mevcut gÃ¶rselleri kopyala
    let images = Array.isArray(blog.images) ? [...blog.images] : [];

    // 2) Silinecek gÃ¶rseller (public_id listesi)
    if (req.body.deleteImages) {
      let deleteList = [];
      try {
        deleteList = JSON.parse(req.body.deleteImages); // ["public_id1", "public_id2"]
      } catch (e) {
        deleteList = [];
      }

      if (deleteList.length) {
        // Cloudinary'den sil
        for (const publicId of deleteList) {
          try {
            await cloudinary.uploader.destroy(publicId);
          } catch (err) {
            logger.error("Cloudinary destroy error (edit):", err);
          }
        }

        // DB'den sil
        images = images.filter(
          (img) => !deleteList.includes(img.public_id)
        );
      }
    }

    // 3) Yeni eklenen gÃ¶rseller (JS tarafÄ±nda Cloudinary'e yÃ¼klendi)
    if (req.body.newImagesJson) {
      try {
        const newImgs = JSON.parse(req.body.newImagesJson); // [{url, public_id}, ...]
        if (Array.isArray(newImgs) && newImgs.length) {
          images = images.concat(
            newImgs.filter((i) => i.url && i.public_id)
          );
        }
      } catch (e) {
        logger.warn("newImagesJson parse error:", e);
      }
    }

    // 4) Blog alanlarÄ±nÄ± gÃ¼ncelle
    blog.title = title;
    blog.content = content;
    blog.images = images;

    await blog.save();

    return res.redirect(`/blog/${blog._id}`);
  } catch (err) {
    logger.error("BLOG UPDATE ERROR:", err);
    const post = await Post.findById(req.params.id).lean();
    return res.render("pages/blogDuzenle", {
      post,
      error: "Bir hata oluÅŸtu.",
      csrfToken: req.csrfToken(),
    });
  }
});

/* ============================================================
   BLOG SÄ°L
============================================================ */
blogs.post("/:id/sil", auth, async (req, res) => {
  try {
    const post = await Post.findById(req.params.id);
    if (!post) return res.redirect("/blog?error=Blog+bulunamadÄ±");

    const isOwner = post.user_id.toString() === req.user.id;
    const isAdmin = req.user.role === "admin";

    if (!isOwner && !isAdmin)
      return res.redirect("/blog?error=Yetkiniz+yok");

    for (const img of post.images) {
      try {
        await cloudinary.uploader.destroy(img.public_id);
      } catch (err) {
        logger.error("Cloudinary destroy error:", err);
      }
    }

    await Post.findByIdAndDelete(req.params.id);
    return res.redirect("/blog?success=Blog+silindi");
  } catch (err) {
    logger.error("BLOG DELETE ERROR:", err);
    res.status(500).send("Blog silinirken hata oluÅŸtu");
  }
});

/* ============================================================
   YORUM EKLE
============================================================ */
blogs.post(
  "/:id/yorum",
  auth,
  (req, res, next) => {
    req.validationErrorView = "pages/blogDetay";
    req.validationErrorData = {};
    next();
  },
  commentLimiter,
  commentValidation,
  async (req, res) => {
    try {
      const post = await Post.findById(req.params.id);
      if (!post) return res.status(404).render("pages/404");

      await Comment.create({
        post_id: post._id,
        user_id: req.user.id,
        username: req.user.username,
        content: req.body.content.trim(),
      });

      return res.redirect(`/blog/${post._id}`);
    } catch (err) {
      logger.error("YORUM EKLE ERROR:", err);
      return res.redirect(`/blog/${req.params.id}?error=Yorum+eklenemedi`);
    }
  }
);

/* ============================================================
   YORUM SÄ°L
============================================================ */
blogs.post("/:postId/yorum/:commentId/sil", auth, async (req, res) => {
  try {
    const comment = await Comment.findById(req.params.commentId);
    if (!comment) return res.status(404).render("pages/404");

    const isOwner = comment.user_id.toString() === req.user.id;
    const isAdmin = req.user.role === "admin";

    if (!isOwner && !isAdmin)
      return res.status(403).send("Yetkiniz yok.");

    await Comment.findByIdAndDelete(req.params.commentId);
    return res.redirect(`/blog/${req.params.postId}`);
  } catch (err) {
    logger.error("YORUM SÄ°L ERROR:", err);
    res.status(500).send("Yorum silinirken hata oluÅŸtu");
  }
});

/* ============================================================
   YORUM DÃœZENLE
============================================================ */
blogs.get("/:postId/yorum/:commentId/duzenle", auth, async (req, res) => {
  try {
    const comment = await Comment.findById(req.params.commentId).lean();
    if (!comment) return res.status(404).render("pages/404");

    const isOwner = comment.user_id.toString() === req.user.id;
    const isAdmin = req.user.role === "admin";

    if (!isOwner && !isAdmin)
      return res.status(403).send("Yetkiniz yok.");

    res.render("pages/yorumDuzenle", {
      comment,
      postId: req.params.postId,
      csrfToken: req.csrfToken(),
    });
  } catch (err) {
    logger.error("YORUM DÃœZENLE (GET) ERROR:", err);
    res.status(500).send("Yorum dÃ¼zenleme sayfasÄ± aÃ§Ä±lÄ±rken hata oluÅŸtu");
  }
});
blogs.post("/:postId/yorum/:commentId/duzenle", auth, async (req, res) => {
  try {
    const comment = await Comment.findById(req.params.commentId);
    if (!comment) return res.status(404).render("pages/404");

    const isOwner = comment.user_id.toString() === req.user.id;
    const isAdmin = req.user.role === "admin";

    if (!isOwner && !isAdmin)
      return res.status(403).send("Yetkiniz yok.");

    const newContent = (req.body.content || "").trim();
    if (!newContent)
      return res.redirect(`/blog/${req.params.postId}`);

    comment.content = newContent;
    await comment.save();

    return res.redirect(`/blog/${req.params.postId}`);
  } catch (err) {
    logger.error("YORUM DÃœZENLE ERROR:", err);
    res.status(500).send("Yorum dÃ¼zenlenirken hata oluÅŸtu");
  }
});

/* ============================================================
   BLOG DETAY
============================================================ */
blogs.get("/:id", async (req, res) => {
  try {
    const post = await Post.findById(req.params.id).lean();
    if (!post) return res.status(404).render("pages/404");

    const comments = await Comment.find({ post_id: post._id })
      .sort({ date: -1 })
      .lean();

    const isAuth = !!req.user;
    const isOwner = isAuth && post.user_id.toString() === req.user.id;
    const isAdmin = isAuth && req.user.role === "admin";

    res.render("pages/blogDetay", {
      post,
      comments,
      isAuth,
      currentUserId: req.user?.id,
      currentUsername: req.user?.username,
      currentRole: req.user?.role,
      isOwner,
      isAdmin,
      csrfToken: req.csrfToken(),       // ğŸ”¥ BUNU EKLEDÄ°K
      error: req.query.error || null,
      success: req.query.success || null,
    });
  } catch (err) {
    logger.error("BLOG DETAY ERROR:", err);
    res.status(500).send("Hata oluÅŸtu");
  }
});

export default blogs;

routes/hesap.js:
// routes/hesap.js
import express from "express";
import auth from "../middlewares/auth.js";
import User from "../models/User.js";
import Post from "../models/Post.js";
import cloudinary from "../helpers/cloudinary.js";
import Comment from "../models/Comment.js";
import { sendMail } from "../helpers/mail.js";
import {
  accountDeletedMailTemplate,
  verificationMailTemplate,
} from "../helpers/mailTemplates.js";
import Backup from "../models/Backup.js";
import bcrypt from "bcrypt";

const router = express.Router();

/* ============================================================
   HESAP SAYFASI (GET)
============================================================ */
router.get("/", auth, async (req, res) => {
  try {
    const user = await User.findById(req.user.id).lean();

    return res.render("pages/hesap", {
      user,
      success: req.query.success || null,
      error: req.query.error || null,
      showVerify: req.query.showVerify || null,
      showNewPasswordBox: req.query.showNewPasswordBox || false,
    });
  } catch (err) {
    console.log(err);
    return res.render("pages/hesap", { error: "Hesap yÃ¼klenemedi" });
  }
});

/* ============================================================
   PROFÄ°L BÄ°LGÄ°LERÄ° GÃœNCELLE
============================================================ */
router.post("/profil", auth, async (req, res) => {
  try {
    const { name, surname, email, bio } = req.body;
    const user = await User.findById(req.user.id);

    if (!user) return res.redirect("/hesap?error=KullanÄ±cÄ±+bulunamadÄ±");

    if (email && email !== user.email) {
      const exists = await User.findOne({
        email,
        _id: { $ne: user._id },
      });

      if (exists) {
        return res.redirect("/hesap?error=Bu+email+baÅŸka+bir+hesapta+kayÄ±tlÄ±");
      }
    }

    user.name = name;
    user.surname = surname;
    user.email = email;
    user.bio = bio?.trim() || "";
    await user.save();

    return res.redirect("/hesap?success=Profil+bilgileri+gÃ¼ncellendi");
  } catch (err) {
    console.log(err);
    return res.redirect("/hesap?error=GÃ¼ncelleme+baÅŸarÄ±sÄ±z");
  }
});

/* ============================================================
   Ã‡EREZ AYARLARI
============================================================ */
router.post("/cookies", auth, async (req, res) => {
  try {
    const user = await User.findById(req.user.id);
    user.analyticsCookies = !!req.body.analyticsCookies;
    user.personalizationCookies = !!req.body.personalizationCookies;
    await user.save();
    return res.redirect("/hesap?success=Ã‡erez+ayarlarÄ±+gÃ¼ncellendi");
  } catch {
    return res.redirect("/hesap?error=Ã‡erez+ayarlarÄ±+kaydedilemedi");
  }
});

/* ============================================================
   VERÄ° KULLANIMI
============================================================ */
router.post("/data-usage", auth, async (req, res) => {
  try {
    const user = await User.findById(req.user.id);

    user.serviceDataUsage = !!req.body.serviceDataUsage;
    user.personalizedContent = !!req.body.personalizedContent;

    await user.save();
    return res.redirect("/hesap?success=Veri+ayarlarÄ±+gÃ¼ncellendi");
  } catch {
    return res.redirect("/hesap?error=Veri+ayarlarÄ±+kaydedilemedi");
  }
});

/* ============================================================
   ğŸ”¥ AVATAR YÃœKLEME (Cloudinary public_id dahil)
============================================================ */
router.post("/avatar-yukle", auth, async (req, res) => {
  try {
    const { avatarUrl, avatarPublicId } = req.body; // ğŸ‘ˆ isimler form ile aynÄ±

    if (!avatarUrl) {
      return res.redirect("/hesap?error=Avatar+yÃ¼klenemedi");
    }

    const user = await User.findById(req.user.id);

    // eski avatarÄ± Cloudinary'den sil
    if (user.avatarPublicId) {
      try {
        await cloudinary.uploader.destroy(user.avatarPublicId);
      } catch (e) {
        console.log("Eski avatar silinemedi:", e.message);
      }
    }

    user.avatar = avatarUrl; // ğŸ‘ˆ url buraya
    user.avatarPublicId = avatarPublicId || null;

    await user.save();
    return res.redirect("/hesap?success=Avatar+gÃ¼ncellendi");
  } catch (err) {
    console.error(err);
    return res.redirect("/hesap?error=Avatar+gÃ¼ncellenemedi");
  }
});

/* ============================================================
   ğŸ”¥ KAPAK FOTO YÃœKLEME (Cloudinary public_id dahil)
============================================================ */
router.post("/kapak-yukle", auth, async (req, res) => {
  try {
    const { coverUrl, coverPublicId } = req.body; // ğŸ‘ˆ form isimleri

    if (!coverUrl) {
      return res.redirect("/hesap?error=Kapak+yÃ¼klenemedi");
    }

    const user = await User.findById(req.user.id);

    if (user.coverPublicId) {
      try {
        await cloudinary.uploader.destroy(user.coverPublicId);
      } catch (e) {
        console.log("Eski kapak silinemedi:", e.message);
      }
    }

    user.coverPhoto = coverUrl; // ğŸ‘ˆ user modeldeki alan
    user.coverPublicId = coverPublicId || null;

    await user.save();
    return res.redirect("/hesap?success=Kapak+fotoÄŸrafÄ±+gÃ¼ncellendi");
  } catch (err) {
    console.error(err);
    return res.redirect("/hesap?error=Kapak+fotoÄŸrafÄ±+gÃ¼ncellenemedi");
  }
});

/* ============================================================
   SOSYAL MEDYA
============================================================ */
router.post("/social", auth, async (req, res) => {
  try {
    const { instagram, x, github } = req.body;

    await User.findByIdAndUpdate(req.user.id, {
      social: { instagram, x, github },
    });

    return res.redirect("/hesap?success=Sosyal+medya+gÃ¼ncellendi");
  } catch {
    return res.redirect("/hesap?error=GÃ¼ncellenemedi");
  }
});

/* ============================================================
   HESAP SÄ°LME
============================================================ */
router.post("/sil", auth, async (req, res) => {
  try {
    const { password } = req.body;
    const user = await User.findById(req.user.id);

    if (!password) return res.redirect("/hesap?error=Åifre+girilmedi");
    const valid = await bcrypt.compare(password, user.password);
    if (!valid) return res.redirect("/hesap?error=Åifre+yanlÄ±ÅŸ");

    const posts = await Post.find({ user_id: user._id }).lean();
    const comments = await Comment.find({ user_id: user._id }).lean();

    await Backup.create({
      userId: user._id,
      username: user.username,
      email: user.email,
      userData: { profile: user.toObject(), posts, comments },
    });

    await Post.deleteMany({ user_id: user._id });
    await Comment.deleteMany({ user_id: user._id });
    await User.findByIdAndDelete(user._id);

    await sendMail(
      user.email,
      "HesabÄ±nÄ±z Silindi",
      accountDeletedMailTemplate(user.username)
    );

    res.clearCookie("auth_token");

    return res.redirect("/?success=HesabÄ±nÄ±z+silindi");
  } catch (err) {
    console.error(err);
    return res.redirect("/hesap?error=Silinemedi");
  }
});

/* ============================================================
   ÅÄ°FRE KODU GÃ–NDER
============================================================ */
router.post("/sifre-kod", auth, async (req, res) => {
  try {
    const user = await User.findById(req.user.id);

    const code = Math.floor(100000 + Math.random() * 900000).toString();
    user.resetCode = code;
    user.resetCodeExpires = new Date(Date.now() + 10 * 60000);
    await user.save();

    const html = verificationMailTemplate(`${user.name} ${user.surname}`, code);
    await sendMail(user.email, "DoÄŸrulama Kodunuz", html);

    return res.redirect("/hesap?success=Kod+gÃ¶nderildi&showVerify=1");
  } catch {
    return res.redirect("/hesap?error=Kod+gÃ¶nderilemedi");
  }
});

/* ============================================================
   KOD DOÄRULAMA
============================================================ */
router.post("/sifre-kod-dogrula-form", auth, async (req, res) => {
  const { code } = req.body;
  const user = await User.findById(req.user.id);

  if (!user || !user.resetCode)
    return res.redirect("/hesap?error=Kod+talep+edilmedi&showVerify=1");

  if (user.resetCodeExpires < new Date())
    return res.redirect("/hesap?error=SÃ¼re+doldu&showVerify=1");

  if (code.trim() !== user.resetCode)
    return res.redirect("/hesap?error=Kod+yanlÄ±ÅŸ&showVerify=1");

  return res.redirect("/hesap/sifre-yeni");
});

/* ============================================================
   YENÄ° ÅÄ°FRE OLUÅTURMA SAYFASI (GET)
============================================================ */
router.get("/sifre-yeni", auth, async (req, res) => {
  const user = await User.findById(req.user.id).lean();
  return res.render("pages/hesap", {
    user,
    showNewPasswordBox: true,
  });
});

/* ============================================================
   YENÄ° ÅÄ°FRE KAYDET
============================================================ */
router.post("/sifre-yeni", auth, async (req, res) => {
  try {
    const { password1, password2 } = req.body;
    const user = await User.findById(req.user.id);

    if (!password1 || !password2)
      return res.redirect("/hesap?error=Åifre+boÅŸ+olamaz&showNewPasswordBox=1");

    if (password1 !== password2)
      return res.redirect(
        "/hesap?error=Åifreler+eÅŸleÅŸmiyor&showNewPasswordBox=1"
      );

    if (password1.length < 6)
      return res.redirect(
        "/hesap?error=Åifre+en+az+6+karakter+olmalÄ±&showNewPasswordBox=1"
      );

    user.password = await bcrypt.hash(password1, 10);
    await user.save();

    return res.redirect("/hesap?success=Åifre+gÃ¼ncellendi");
  } catch {
    return res.redirect("/hesap?error=Bir+hata+oluÅŸtu&showNewPasswordBox=1");
  }
});

export default router;