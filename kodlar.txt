<section class="blog-edit">
  <h1 class="edit-title">Blog Düzenle</h1>

  <form id="blogEditForm" method="POST" action="/blog/duzenle/{{post._id}}">
    <input type="hidden" name="_csrf" value="{{csrfToken}}" />

    <!-- SİLİNECEK GÖRSELLER -->
    <input type="hidden" id="deleteImages" name="deleteImages" value="[]" />

    <!-- YENİ EKLENECEK GÖRSELLER -->
    <input type="hidden" id="newImagesJson" name="newImagesJson" value="[]" />

    <!-- BAŞLIK -->
    <div class="form-group">
      <label>Başlık</label>
      <input type="text" name="title" value="{{post.title}}" required />
    </div>

    <!-- İÇERİK -->
    <div class="form-group">
      <label>İçerik</label>
      <textarea name="content" rows="10" required>{{post.content}}</textarea>
    </div>

    <!-- MEVCUT GÖRSELLER -->
    <div class="edit-gallery">
      <p class="gallery-title">Mevcut Görseller</p>

      {{#if post.images.length}}
        <div class="gallery-grid">
          {{#each post.images}}
            <div class="gallery-item">
              <img src="{{this.url}}" alt="Görsel" />

              <label class="remove-label">
                <input
                  type="checkbox"
                  class="deleteImageCheck"
                  value="{{this.fileId}}"
                />
                Sil
              </label>
            </div>
          {{/each}}
        </div>
      {{else}}
        <p class="no-images">
          Bu blogda görsel yok. Varsayılan görsel kullanılacaktır.
        </p>
      {{/if}}
    </div>

    <!-- YENİ GÖRSEL EKLE -->
    <div class="form-group">
      <label>Yeni Görsel Ekle</label>

      <span class="img-hint">
        Önerilen boyut: 1600×900 • Maks. 5 görsel • Her biri en fazla 10 MB
        <strong>Tüm görselleri tek seferde seçiniz.</strong>
      </span>

      <button type="button" class="upload-label" id="openEditImagePicker">
        Görsel Yükle
      </button>

      <input
        type="file"
        id="newImages"
        class="file-input"
        accept="image/*"
        multiple
      />

      <div id="editPreviewBox" class="preview-container"></div>
    </div>

    <button class="btn save">Kaydet</button>
  </form>

  <!-- LOADER -->
  <div id="blogEditLoading" class="blog-upload-loader" style="display:none;">
    <div class="blog-loader-box">
      <div class="blog-spinner"></div>
      <span>Görseller yükleniyor...</span>
    </div>
  </div>
</section>

<script type="module" src="/js/uploadClient.js"></script>
<script type="module" src="/js/blogEditUpload.js"></script>
  

  // public/js/blogEditUpload.js
import { uploadImage } from "./uploadClient.js";

const form = document.getElementById("blogEditForm");
const deleteInput = document.getElementById("deleteImages");

const input = document.getElementById("newImages");
const preview = document.getElementById("editPreviewBox");
const hiddenNew = document.getElementById("newImagesJson");

const openBtn = document.getElementById("openEditImagePicker");
const loader = document.getElementById("blogEditLoading");

if (openBtn && input) {
  openBtn.addEventListener("click", () => input.click());
}

let newImages = [];

/* ============================
   ✅ YENİ GÖRSEL YÜKLEME
============================ */
input?.addEventListener("change", async () => {
  preview.innerHTML = "";
  newImages = [];

  const files = Array.from(input.files);
  if (files.length > 5) {
    alert("En fazla 5 görsel yüklenebilir");
    input.value = "";
    return;
  }

  loader.style.display = "flex";

  try {
    for (const file of files) {
      const img = await uploadImage(file, "/blogs");
      newImages.push(img);

      preview.innerHTML += `
        <div class="preview-item">
          <img src="${img.url}" class="preview-img" />
        </div>
      `;
    }

    hiddenNew.value = JSON.stringify(newImages);
  } catch (err) {
    console.error("UPLOAD ERROR:", err);
    alert("Görsel yüklenirken hata oluştu.");
    preview.innerHTML = "";
    hiddenNew.value = "[]";
  } finally {
    loader.style.display = "none";
  }
});

/* ============================
   ✅ FORM SUBMIT – SİLİNECEKLERİ TOPLA
============================ */
form.addEventListener("submit", () => {
  const toDelete = [];

  // ⚠️ CHECKBOX'LARI SUBMIT ANINDA SEÇ
  document
    .querySelectorAll(".deleteImageCheck")
    .forEach((chk) => {
      if (chk.checked && chk.value && chk.value.trim() !== "") {
        toDelete.push(chk.value); // fileId
      }
    });

  deleteInput.value = JSON.stringify(toDelete);

  console.log("✅ SİLİNECEK GÖRSELLER:", toDelete);
});

document.querySelectorAll(".deleteImageCheck").length
2

SUBMIT ÇALIŞTI yazısı geldi